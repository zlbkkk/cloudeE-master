# 自动项目发现功能使用指南

## 功能概述

自动项目发现功能允许系统自动扫描 Git 组织（如 GitLab 群组）下的所有项目，并自动分析项目间的依赖关系，无需手动逐个添加项目关联。

## 使用步骤

### 第一步：获取 GitLab Access Token

1. 登录你的 GitLab：`https://git.hrlyit.com`
2. 点击右上角头像 → **Settings**（设置）
3. 左侧菜单选择 **Access Tokens**（访问令牌）
4. 创建新 Token：
   - **Token 名称**：`code-analysis-system`
   - **过期时间**：选择合适的时间（建议 1 年）
   - **权限勾选**：
     - ✅ `read_api` （读取 API）
     - ✅ `read_repository` （读取仓库）
5. 点击 **Create personal access token**
6. **复制生成的 Token**（只显示一次，请妥善保存）

### 第二步：配置 Git 组织

1. 打开系统，点击左侧菜单的 **"自动发现"**
2. 点击右上角的 **"新建配置"** 按钮
3. 填写配置信息：
   - **Git 服务器地址**：`https://git.hrlyit.com`
   - **组织/群组名称**：`beehive`
   - **Git 服务器类型**：选择 `GitLab`
   - **访问 Token**：粘贴第一步获取的 Token
   - **默认分支**：`master`（或 `main`）
4. 点击 **"保存"**

### 第三步：测试连接

1. 保存配置后，点击 **"测试连接"** 按钮
2. 如果显示 **"连接成功！"**，说明配置正确
3. 如果失败，请检查：
   - Git 服务器地址是否正确
   - Token 是否有效
   - 网络连接是否正常

### 第四步：发现项目

1. 点击 **"立即发现项目"** 按钮
2. 系统会自动：
   - 调用 GitLab API 获取 `beehive` 组织下的所有项目
   - 保存项目信息到数据库
   - 显示发现的项目列表
3. 等待几秒钟，系统会显示：
   ```
   发现完成！新增 23 个项目，更新 0 个项目
   ```

### 第五步：查看发现的项目

在页面下方的表格中，你可以看到所有自动发现的项目：
- 项目名称
- Git 地址
- 编程语言
- 默认分支
- 状态（启用/禁用）

## 使用场景

### 场景 1：触发分析时自动使用发现的项目

当你触发代码分析时：
1. 选择主项目（如 `beehive-h5-frontend`）
2. 启用 **"跨项目分析"** 开关
3. 系统会自动包含所有相关的依赖项目
4. 无需手动选择关联项目

### 场景 2：定期更新项目列表

如果组织中新增了项目：
1. 打开 **"自动发现"** 页面
2. 点击 **"立即发现项目"** 按钮
3. 系统会自动更新项目列表

### 场景 3：管理发现的项目

在项目列表中，你可以：
- 查看项目详情
- 启用/禁用特定项目
- 查看项目的编程语言和分支信息

## 常见问题

### Q1: Token 权限不足怎么办？

**A:** 确保 Token 具有以下权限：
- `read_api` - 读取 API
- `read_repository` - 读取仓库

如果权限不足，请重新生成 Token 并勾选正确的权限。

### Q2: 发现不到项目怎么办？

**A:** 请检查：
1. 组织名称是否正确（如 `beehive`）
2. Token 是否有权限访问该组织
3. 组织下是否确实有项目

### Q3: 如何更新 Token？

**A:** 
1. 打开 **"自动发现"** 页面
2. 点击 **"编辑配置"** 按钮
3. 在 **"访问 Token"** 字段输入新的 Token
4. 点击 **"保存"**

### Q4: 支持哪些 Git 服务器？

**A:** 目前支持：
- ✅ GitLab（完全支持）
- ⏳ GitHub（即将支持）
- ⏳ Gitea（即将支持）

### Q5: Token 会被泄露吗？

**A:** 不会。Token 的安全性：
- Token 存储在数据库中（加密存储）
- 只有系统后端可以访问
- 前端界面不会显示完整的 Token
- 可以随时在 GitLab 中撤销 Token

## 技术原理

### 自动发现流程

```
1. 用户配置 Git 组织信息
   ↓
2. 系统调用 GitLab API
   GET https://git.hrlyit.com/api/v4/groups/beehive/projects
   ↓
3. 获取组织下的所有项目列表
   ↓
4. 解析项目信息（名称、Git 地址、语言等）
   ↓
5. 保存到数据库
   ↓
6. 显示在前端界面
```

### API 端点

- **创建/更新组织配置**：`POST/PUT /api/git-organizations/`
- **测试连接**：`POST /api/git-organizations/{id}/test-connection/`
- **发现项目**：`POST /api/git-organizations/{id}/discover-projects/`
- **查询发现的项目**：`GET /api/discovered-projects/`

## 下一步

配置完成后，你可以：
1. 在 **"项目关联"** 页面查看手动配置的关联
2. 在 **"服务分析"** 页面触发跨项目分析
3. 系统会自动使用发现的项目进行分析

## 反馈与支持

如有问题，请联系系统管理员或查看系统日志。

# 需求文档

## 简介

本文档规定了在代码变更影响分析系统中实现跨项目影响分析功能的需求。该系统目前仅支持分析单个 Git 仓库。此增强功能将使系统能够在微服务架构中检测多个相关项目之间的 API 调用和类引用。

## 术语表

- **主项目（Main Project）**: 正在分析代码变更的主要 Git 仓库
- **关联项目（Related Project）**: 可能依赖于主项目或被主项目依赖的次要 Git 仓库
- **跨项目影响（Cross-Project Impact）**: 从主项目到关联项目或反之的代码依赖或 API 调用
- **项目关联（Project Relation）**: 主项目与一个或多个关联项目之间的配置关联
- **静态分析（Static Analysis）**: 在不执行代码的情况下进行的代码解析和分析
- **API 追踪器（API Tracer）**: 跟踪 API 端点定义及其使用情况的组件
- **多项目追踪器（Multi-Project Tracer）**: 协调多个项目仓库分析的组件

## 需求

### 需求 1

**用户故事：** 作为开发人员，我希望配置项目之间的关联关系，以便系统知道要扫描哪些项目以查找跨项目影响。

#### 验收标准

1. WHEN 用户创建项目关联 THEN 系统 SHALL 存储主项目名称、主项目 Git 地址、关联项目名称、关联项目 Git 地址和分支信息
2. WHEN 用户通过主项目 Git 地址查询项目关联 THEN 系统 SHALL 返回该主项目的所有活动关联项目
3. WHEN 用户更新项目关联状态 THEN 系统 SHALL 切换 is_active 标志并持久化更改
4. WHEN 用户删除项目关联 THEN 系统 SHALL 从数据库中删除该关联
5. THE 系统 SHALL 对主项目 Git 地址和关联项目 Git 地址的组合强制执行唯一性约束

### 需求 2

**用户故事：** 作为开发人员，我希望系统自动克隆和更新关联项目，以便分析使用所有相关仓库的最新代码。

#### 验收标准

1. WHEN 启用跨项目分析触发分析任务 THEN 系统 SHALL 查询主项目的所有活动关联项目
2. WHEN 关联项目仓库在本地不存在 THEN 系统 SHALL 从配置的 Git 地址克隆仓库
3. WHEN 关联项目仓库在本地存在 THEN 系统 SHALL 执行 git fetch 以检索最新更改
4. WHEN 更新关联项目 THEN 系统 SHALL 切换到配置的分支并重置到该分支的最新提交
5. IF 关联项目克隆或更新失败 THEN 系统 SHALL 记录错误并继续处理其他项目，而不会导致整个分析失败

### 需求 3

**用户故事：** 作为开发人员，我希望系统扫描所有关联项目以查找对已更改类的引用，以便我可以识别哪些项目受到我的代码更改的影响。

#### 验收标准

1. WHEN 主项目中的 Java 类被修改 THEN 系统 SHALL 提取完全限定的类名
2. WHEN 扫描关联项目以查找类引用 THEN 系统 SHALL 搜索导入语句和修改类的使用情况
3. WHEN 在关联项目中找到类引用 THEN 系统 SHALL 记录项目名称、文件路径、行号和代码片段
4. WHEN 多个关联项目引用同一个类 THEN 系统 SHALL 按项目名称对影响进行分组
5. THE 系统 SHALL 在搜索跨项目影响时跳过主项目以避免重复结果

### 需求 4

**用户故事：** 作为开发人员，我希望系统检测跨项目的 API 调用，以便我可以了解哪些外部服务或前端依赖于我的后端更改。

#### 验收标准

1. WHEN 控制器或服务类中的方法被修改 THEN 系统 SHALL 识别受该方法影响的 API 端点
2. WHEN 扫描关联项目以查找 API 使用情况 THEN 系统 SHALL 搜索对已识别 API 端点的 HTTP 调用
3. WHEN 在关联项目中找到 API 调用 THEN 系统 SHALL 记录 API 端点、项目名称、文件路径、行号和代码片段
4. WHEN API 端点在多个项目中有多个调用者 THEN 系统 SHALL 列出按项目分组的所有调用位置
5. THE 系统 SHALL 支持在 Java 后端代码和 JavaScript/TypeScript 前端代码中检测 API 调用

### 需求 5

**用户故事：** 作为开发人员，我希望在分析报告中看到跨项目影响，以便我可以规划所有受影响项目的测试和部署。

#### 验收标准

1. WHEN 生成包含跨项目影响的分析报告 THEN 系统 SHALL 包含专门的跨项目影响部分
2. WHEN 显示跨项目影响 THEN 系统 SHALL 按关联项目名称对影响进行分组
3. WHEN 显示影响条目 THEN 系统 SHALL 显示影响类型（类引用或 API 调用）、文件路径、行号、代码片段和描述
4. WHEN 未找到跨项目影响 THEN 系统 SHALL 显示一条消息，指示未检测到跨项目影响
5. THE 系统 SHALL 在报告中区分主项目影响和跨项目影响

### 需求 6

**用户故事：** 作为开发人员，我希望能够为每个分析任务启用或禁用跨项目分析，以便我可以选择何时执行更耗时的跨项目扫描。

#### 验收标准

1. WHEN 触发分析任务 THEN 系统 SHALL 提供启用跨项目分析的选项
2. WHEN 跨项目分析被禁用 THEN 系统 SHALL 仅分析主项目仓库
3. WHEN 跨项目分析被启用 THEN 系统 SHALL 扫描主项目和所有活动关联项目
4. WHEN 显示分析触发表单 THEN 系统 SHALL 显示如果启用跨项目分析将扫描哪些关联项目
5. THE 系统 SHALL 在任务元数据中记录是否启用了跨项目分析

### 需求 7

**用户故事：** 作为系统管理员，我希望系统缓存项目索引，以便后续分析更快，并且不会不必要地重建索引。

#### 验收标准

1. WHEN 构建项目索引 THEN 系统 SHALL 基于项目路径和最新 Git 提交哈希生成缓存键
2. WHEN 初始化多项目追踪器 THEN 系统 SHALL 在构建新索引之前尝试加载缓存的索引
3. WHEN 找到有效的缓存索引 THEN 系统 SHALL 从缓存加载索引而不是重建
4. WHEN 项目的 Git 提交发生变化 THEN 系统 SHALL 使旧缓存失效并构建新索引
5. WHEN 将索引保存到缓存失败 THEN 系统 SHALL 记录警告并继续而不缓存

### 需求 8

**用户故事：** 作为开发人员，我希望系统并行克隆关联项目，以便在分析多个项目时准备阶段更快。

#### 验收标准

1. WHEN 克隆或更新多个关联项目 THEN 系统 SHALL 使用线程池并行执行操作
2. WHEN 并行克隆操作成功完成 THEN 系统 SHALL 将项目路径添加到扫描根列表
3. WHEN 并行克隆操作失败 THEN 系统 SHALL 记录错误而不阻塞其他操作
4. THE 系统 SHALL 限制并发克隆操作的数量以避免资源耗尽
5. WHEN 所有克隆操作完成 THEN 系统 SHALL 继续进行多项目分析

### 需求 9

**用户故事：** 作为开发人员，我希望详细记录跨项目分析过程，以便我可以排查问题并了解系统正在做什么。

#### 验收标准

1. WHEN 跨项目分析开始 THEN 系统 SHALL 记录正在扫描的关联项目数量
2. WHEN 扫描每个关联项目 THEN 系统 SHALL 记录项目名称和扫描进度
3. WHEN 找到跨项目影响 THEN 系统 SHALL 记录发现的影响数量
4. WHEN 跨项目分析期间发生错误 THEN 系统 SHALL 记录带有堆栈跟踪的详细错误消息
5. THE 系统 SHALL 在整个分析过程中使用人类可读的进度消息更新任务日志

### 需求 10

**用户故事：** 作为系统架构师，我希望跨项目分析是模块化和可扩展的，以便我们将来可以添加对其他语言和分析类型的支持。

#### 验收标准

1. THE 系统 SHALL 实现一个 MultiProjectTracer 类来协调多个项目的分析
2. THE MultiProjectTracer SHALL 为每个项目维护单独的 ApiUsageTracer 和 StaticAnalyzer 实例
3. WHEN 添加对新语言的支持 THEN 系统 SHALL 允许插入特定于语言的分析器
4. THE 系统 SHALL 在项目管理（克隆/更新）、索引和影响分析之间分离关注点
5. THE 系统 SHALL 提供清晰的接口以扩展跨项目分析功能
